<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="../../js/jquery.js"></script>
    <script src="../../js/swiper.js"></script>
    <script src="../../js/twbsPagination.js"></script>
    <script src="../../js/fullCalendar.js"></script>
    <script src="../../js/ui_common.js"></script>
    <script src="../../js/popper.js"></script>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/pages.css">
    <link rel="shortcut icon" href="../../images/common/favicon.ico">
    <title>보훈문화종합포털</title>
</head>
<body>
<div class="guide-container">
    <div class="guide-content">
        <div class="guide-heading">이미지 뷰어</div>
        <div class="pswp-gallery" id="gallery">
            <a href="https://cdn.photoswipe.com/photoswipe-demo-images/photos/1/img-2500.jpg" data-pswp-width="1875" data-pswp-height="2500" target="_blank">
                <img src="https://cdn.photoswipe.com/photoswipe-demo-images/photos/1/img-200.jpg" alt="">
            </a>
            <a href="https://cdn.photoswipe.com/photoswipe-demo-images/photos/2/img-2500.jpg" data-pswp-width="1669" data-pswp-height="2500" target="_blank">
                <img src="https://cdn.photoswipe.com/photoswipe-demo-images/photos/2/img-200.jpg" alt="">
            </a>
            <a href="https://cdn.photoswipe.com/photoswipe-demo-images/photos/3/img-2500.jpg" data-pswp-width="2500" data-pswp-height="1666" target="_blank">
                <img src="https://cdn.photoswipe.com/photoswipe-demo-images/photos/3/img-200.jpg" alt="">
            </a>
<!--            <a href="https://cdn.photoswipe.com/photoswipe-demo-images/photos/4/img-2500.jpg" data-pswp-width="2500" data-pswp-height="1667" target="_blank">-->
<!--                <img src="https://cdn.photoswipe.com/photoswipe-demo-images/photos/4/img-200.jpg" alt="">-->
<!--            </a>-->
        </div>
    </div>
</div>
<script type="module">
    import PhotoSwipeLightbox from '../../js/photoswipe-lightbox.js';
    import PhotoSwipeDeepZoom from '../../js/photoswipe-deep-zoom-plugin.js';

    const imageData = [
        {
            title: "대한민국 임시정부 요인",
            desc: "1919년 4월 11일 중국 상하이에서 설립된 대한민국 최초의 정부입니다. 1919년 4월 11일 중국 상하이에서 설립된 대한민국 최초의 정부입니다. 1919년 4월 11일 중국 상하이에서 설립된 대한민국 최초의 정부입니다.",
            tags: [
                { label: "독립", type: "blue" },
                { label: "임시정부", type: "green" }
            ]
        },
        {
            title: "3.1 운동 상해",
            desc: "상해에서 진행된 3.1 운동의 기록 사진입니다.",
            tags: [
                { label: "3.1운동", type: "blue" },
                { label: "상해", type: "green" }
            ]
        },
        {
            title: "3.1 만세운동 현장",
            desc: "전국적으로 퍼져나간 만세 운동의 역사적 현장입니다.",
            tags: [
                { label: "만세운동", type: "gray" },
                { label: "역사", type: "red" }
            ]
        }
    ];

    const TAG_TYPE_CLASS = {
        blue:  'tag-blue',
        green: 'tag-green',
        red:   'tag-red',
        gray:  'tag-gray',
    };

    const DEFAULT_TAG_CLASS = 'tag-default';

    const BASE_PADDING = { top: 60, bottom: 40, left: 100, right: 100 };

    const lightbox = new PhotoSwipeLightbox({
        gallery: '#gallery',
        children: 'a',
        bgOpacity: 0.6,
        showHideAnimationType: 'fade',
        padding: (viewportSize) => ({
            top: BASE_PADDING.top,
            left: BASE_PADDING.left,
            right: BASE_PADDING.right,
            bottom: BASE_PADDING.bottom
        }),
        closeTitle: '닫기',
        zoomTitle: 'Zoom the photo',
        arrowPrevTitle: '',
        arrowNextTitle: '',
        allowPanToNext: false,
        allowMouseDrag: true,
        wheelToZoom: true,
        zoom: false,
        maxZoomLevel: 2,
        pinchToClose: false,
        pswpModule: () => import('../../js/photoswipe.js'),
    });

    const deepZoomPlugin = new PhotoSwipeDeepZoom(lightbox, {
        tileSize: 256
    });

    lightbox.on('uiRegister', function () {
        // Top bar
        lightbox.pswp.ui.registerElement({
            name: 'popup-title',
            order: 0,
            appendTo: 'wrapper',
            onInit: (el, pswp) => {
                el.classList.add('pswp__popup-title');
                el.textContent = '대한민국 임시정부 요인';
                el.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, { passive: false });
            }
        });

        // Top bar (Block pinch)
        lightbox.pswp.on('pointerDown', (e) => {
            const target = e.originalEvent?.target;
            if (target && target.closest && target.closest('.pswp__popup-title')) {
                e.preventDefault();
            }
        });

        // Close Button
        lightbox.pswp.ui.registerElement({
            name: 'custom-close',
            order: 10,
            isButton: true,
            tagName: 'button',
            html: {
                isCustomSVG: true,
                inner: `
      <path d="M24 10l-2-2-6 6-6-6-2 2
               6 6-6 6 2 2 6-6
               6 6 2-2-6-6z"
            id="pswp__icn-close-custom"/>
    `,
                outlineID: 'pswp__icn-close-custom'
            },
            onInit: (el, pswp) => {
                el.classList.add('pswp__button', 'pswp__button--custom-close');
                el.setAttribute('type', 'button');
                el.setAttribute('aria-label', '닫기');
                el.setAttribute('title', '닫기');

                el.addEventListener('click', () => {
                    pswp.close();
                });
            }
        });

        // Download Button
        lightbox.pswp.ui.registerElement({
            name: 'download-button',
            order: 8,
            isButton: true,
            tagName: 'a',
            html: {
                isCustomSVG: true,
                inner: '<path d="M20.5 14.3 17.1 18V10h-2.2v7.9l-3.4-3.6L10 16l6 6.1 6-6.1ZM23 23H9v2h14Z" id="pswp__icn-download"/>',
                outlineID: 'pswp__icn-download'
            },
            onInit: (el, pswp) => {
                el.classList.add('pswp__button', 'pswp__button--download');
                el.setAttribute('download', '');
                el.setAttribute('target', '_blank');
                el.setAttribute('rel', 'noopener');
                el.setAttribute('aria-label', '이미지 다운로드');
                el.setAttribute('title', '이미지 다운로드');

                const update = () => {
                    const slide = pswp.currSlide;
                    if (!slide) return;

                    const src = slide.data?.src;

                    const data = imageData[pswp.currIndex];
                    if (data?.title) el.setAttribute('download', `${data.title}.png`);

                    el.href = src || '';
                    el.toggleAttribute('data-disabled', !src);
                };

                pswp.on('change', update);
                update();
            }
        });

        // Zoom Indicator
        // lightbox.pswp.ui.registerElement({
        //     name: 'zoom-level-indicator',
        //     order: 9,
        //     onInit: (el, pswp) => {
        //         pswp.on('zoomPanUpdate', (e) => {
        //             if (e.slide === pswp.currSlide) {
        //                 el.innerText = Math.round(pswp.currSlide.currZoomLevel * 100) + '%';
        //             }
        //         });
        //     }
        // });

        // Bottom Info
        lightbox.pswp.ui.registerElement({
            name: 'bottom-info',
            order: 9,
            appendTo: 'wrapper',
            onInit: (el, pswp) => {
                el.classList.add('pswp__bottom-info');

                let isUpdating = false;
                let lastBottom = null;
                let rafId = null;

                const renderInfo = () => {
                    const data = imageData[pswp.currIndex] || {};
                    const tags = Array.isArray(data.tags) ? data.tags : [];

                    const tagsHtml = tags.map((t) => {
                        // 문자열도 허용하려면 fallback 포함
                        const label = typeof t === 'string' ? t : (t?.label ?? '');
                        const type  = typeof t === 'string' ? '' : (t?.type ?? '');

                        const cls = TAG_TYPE_CLASS[type] || DEFAULT_TAG_CLASS;

                        return `
                                <span class="tag ${cls}"
                                      data-tag="${type}"
                                      aria-label="${label}">
                                  ${label}
                                </span>
                              `;
                    }).join('');

                    el.innerHTML = `
                                    <div class="pswp__custom-info">
                                      <div class="tags">${tagsHtml}</div>
                                      <h2 class="title">${data.title ?? ''}</h2>
                                      <p class="desc">${data.desc ?? ''}</p>
                                    </div>
                                  `;
                };

                const measureBottom = () => Math.ceil(el.getBoundingClientRect().height) + BASE_PADDING.bottom;

                const applyPaddingIfNeeded = () => {
                    if (isUpdating) return;

                    const bottom = measureBottom();
                    if (bottom === lastBottom) return;

                    lastBottom = bottom;
                    isUpdating = true;

                    pswp.options.padding = {
                        top: BASE_PADDING.top,
                        left: BASE_PADDING.left,
                        right: BASE_PADDING.right,
                        bottom
                    };

                    pswp.updateSize(true);

                    isUpdating = false;
                };

                const scheduleApply = () => {
                    if (rafId) cancelAnimationFrame(rafId);
                    rafId = requestAnimationFrame(() => {
                        rafId = null;
                        applyPaddingIfNeeded();
                    });
                };

                const updateAll = () => {
                    renderInfo();
                    scheduleApply();
                };

                pswp.on('change', updateAll);
                pswp.on('resize', scheduleApply);

                updateAll();
            }
        });

        // Bottom Info (Block pinch)
        lightbox.pswp.on('pointerDown', (e) => {
            const target = e.originalEvent?.target;
            if (target && target.closest && target.closest('.pswp__bottom-info')) {
                e.preventDefault();
            }
        });

        // Prev Label
        lightbox.pswp.ui.registerElement({
            name: 'prev-label',
            appendTo: 'wrapper',
            onInit: (el, pswp) => {
                el.classList.add('pswp__arrow-label', 'pswp__arrow-label--prev');
                el.setAttribute('role', 'tooltip');

                const tid = 'pswpPrevTip';
                el.id = tid;

                const mount = () => {
                    const prevBtn = pswp.element.querySelector('.pswp__button--arrow--prev');
                    if (prevBtn && !prevBtn.contains(el)) {
                        prevBtn.appendChild(el);
                        prevBtn.setAttribute('aria-describedby', tid);
                    }
                };

                const total = imageData.length;

                const update = () => {
                    const prevIndex = (pswp.currIndex - 1 + total) % total;
                    const prevData = imageData[prevIndex];

                    el.textContent = prevData.title;
                    el.removeAttribute('data-empty');
                    mount();
                };

                pswp.on('change', update);
                update();
            }
        });

        // Next Label
        lightbox.pswp.ui.registerElement({
            name: 'next-label',
            appendTo: 'wrapper',
            onInit: (el, pswp) => {
                el.classList.add('pswp__arrow-label', 'pswp__arrow-label--next');
                el.setAttribute('role', 'tooltip');

                const tid = 'pswpNextTip';
                el.id = tid;

                const mount = () => {
                    const nextBtn = pswp.element.querySelector('.pswp__button--arrow--next');
                    if (nextBtn && !nextBtn.contains(el)) {
                        nextBtn.appendChild(el);
                        nextBtn.setAttribute('aria-describedby', tid);
                    }
                };

                const total = imageData.length;

                const update = () => {
                    const nextIndex = (pswp.currIndex + 1) % total;
                    const nextData = imageData[nextIndex];

                    el.textContent = nextData.title;
                    el.removeAttribute('data-empty');
                    mount();
                };

                pswp.on('change', update);
                update();
            }
        });
    });

    lightbox.init();
</script>
</body>
</html>